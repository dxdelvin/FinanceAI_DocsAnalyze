{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/chat.css">

<section class="feed-col">
  <div class="composer card">
    <textarea id="postText" rows="3" maxlength="1000" placeholder="Share something clever…"></textarea>
    <div class="row">
      <button class="btn btn-primary" onclick="sendPost()">Post</button>
      <button id="loadMore" class="btn" style="display:none;margin-left:auto" onclick="loadFeed(true)">Load more</button>
    </div>
  </div>

  <div id="feed"></div>
</section>

<script>
let cursor = null;

const fmt = d => new Date(d).toLocaleString();
const escapeHtml = s => s.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

async function sendPost(){
  const el = document.getElementById('postText');
  const text = el.value.trim();
  if(!text) return;

  const r = await fetch('/api/social/post', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ text })
  });

  if (r.ok) {
    el.value = '';
    document.getElementById('feed').innerHTML = '';
    cursor = null;
    loadFeed();
  } else if (r.status === 401) {
    alert('Please login to post.');
  } else {
    alert('Post failed: ' + (await r.text()));
  }
}

function postCard(p){
  return `<div class="post card">
    <div class="meta">
      <strong>${escapeHtml(p.author_name || 'anon')}</strong>
      <span class="dim" style="margin-left:.5rem">${fmt(p.created_at)}</span>
    </div>
    <div class="text">${escapeHtml(p.text).replace(/\n/g,'<br>')}</div>
    <div class="row" style="gap:.5rem">
      <button class="btn" onclick="likePost('${p.post_id}')">♥ ${p.like_count || 0}</button>
      <button class="btn" onclick="repostPost('${p.post_id}')">↻ ${p.repost_count || 0}</button>
    </div>
  </div>`;
}

async function loadFeed(more=false){
  let url = '/api/social/feed?limit=10';
  if (more && cursor) url += '&cursor=' + encodeURIComponent(cursor);

  const wrap = document.getElementById('feed');
  const r = await fetch(url);

  if (!r.ok) {
    wrap.innerHTML = `<div class="card dim">Failed to load feed: ${await r.text()}</div>`;
    return;
  }

  const data = await r.json();
  const items = data.items || [];

  if (!more) wrap.innerHTML = '';
  if (items.length === 0 && !data.next) {
    wrap.innerHTML = `<div class="card dim">No posts yet. Be the first!</div>`;
  } else {
    items.forEach(p => wrap.insertAdjacentHTML('beforeend', postCard(p)));
  }

  cursor = data.next || null;
  document.getElementById('loadMore').style.display = cursor ? 'inline-block' : 'none';
}

async function likePost(id){
  await fetch('/api/social/like', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ post_id: id })
  });
  document.getElementById('feed').innerHTML = '';
  cursor = null;
  loadFeed();
}

async function repostPost(id){
  await fetch('/api/social/repost', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ post_id: id })
  });
  document.getElementById('feed').innerHTML = '';
  cursor = null;
  loadFeed();
}

document.addEventListener('DOMContentLoaded', () => loadFeed());
</script>
{% endblock %}
